<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8">
		<title>Teste de Classe \jacknpoe\CalculaJuros (de juros a acréscimo e de acréscimo a juros) em JavaScript</title>
 		<link rel="stylesheet" href="js_testejuros.css"/>
		<link rel="icon" type="image/png" href="js_testejuros.png"/>
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body>
		<h1>Juros para Acréscimo / Acréscimo para Juros em JavaScript<br></h1>

		<p>Quantidade: <input type="number" name="quantidade" id="quantidade" style="width: 50px" autofocus></p>
		<p>Tipo: <input type="radio" name="tipo" id="tipo" value="simples" checked>simples
			     <input type="radio" name="tipo" id="tipo" value="composto">composto</p>
		<p>Período: <input type="number" name="periodo" id="periodo" style="width: 50px"> dias (período sobre o qual o juros incide, normalmente 30 dias)</p>
		<p>Pesos: <input type="text" name="pesos" id="pesos" style="width: 200px"> (pesos separados por vírgula, para parcelas iguais deixe vazio ou 1,1,1,1...)</p>
		<p>Pagamentos: <input type="text" name="pagamentos" id="pagamentos" style="width: 200px"> (prazos de pagamento separados por vírgula, para 30,60,90,120... deixar vazio)</p> 
		<p>Cálculo: <input type="radio" name="calculo" id="calculo" value="jurosparaacrescimo" checked>juros para acréscimo
			        <input type="radio" name="calculo" id="calculo" value="acrescimoparajuros">acréscimo para juros</p>
		<p>Percentual: <input type="text" name="valor" id="valor" style="width: 100px">%</p>
		<p><input type="submit" name="calcular" value="Calcular" onclick="calcular()"></p>

		<br><p id="resultado">Resultado:</p><br><br>
		<p><a href="https://github.com/jacknpoe/js_testejuros">Repositório no GitHub</a></p><br><br>
		<form action="index.html" method="POST" style="border: 0px">
			<p><input type="submit" name="voltar" value="Voltar"></p>
		</form>

		<script>
			// Classe que faz o cálculo do juros, sendo que precisa de arrays pra isso
			class CalculaJuros{
				constructor(quantidade=0, composto=false, periodo=30){
					this.Quantidade = quantidade
					this.Composto = composto
					this.Periodo = periodo
					this.Pagamentos = new Array(0)
					this.Pesos = new Array(0)
				}

				// "Define as datas de pagamento a partir de uma string separada pelo delimitador
				setPagamentos(delimitador=",", pagamentos=""){
					if( pagamentos == ""){
						for(let c = 0; c < this.Quantidade; c++){
							this.Pagamentos[c] = (1 + c) * this.Periodo
						}
					} else {
						let temporaria = pagamentos.split(delimitador)
						for(let c = 0; c < this.Quantidade; c++){
							if(isNaN(Number(temporaria[c]))) return false
							this.Pagamentos[c] = Number(temporaria[c])
						}
					}
					return true
				}

				// "Define as datas de pagamento a partir de uma string separada pelo delimitador
				setPesos(delimitador=",", pesos=""){
					if( pesos == ""){
						for(let c = 0; c < this.Quantidade; c++){
							this.Pesos[c] = 1
						}
					} else {
						let temporaria = pesos.split(delimitador)
						for(let c = 0; c < this.Quantidade; c++){
							if(isNaN(Number(temporaria[c]))) return false
							this.Pesos[c] = Number(temporaria[c])
						}
					}
					return true
				}

				// Retorna a soma total de todos os pesos
				getPesoTotal(){
					let acumulador = 0
					for(let c = 0; c < this.Quantidade; c++){
						acumulador += this.Pesos[c]
					}
					return acumulador
				}

				// Calcula o acréscimo a partir dos juros
				jurosParaAcrescimo(juros=0){
					if(juros == 0 || this.Quantidade == 0 || this.Periodo == 0) return 0

					let total = this.getPesoTotal()
					let acumulador = 0
					let soZero = true

					for(let i = 0; i < this.Quantidade; i++){
						if(this.Pagamentos[i] > 0 && this.Pesos[i] > 0) soZero = false
						if(this.Composto){
							acumulador += this.Pesos[i] / ((1 + juros / 100) ** (this.Pagamentos[i] / this.Periodo))
						} else{
							acumulador += this.Pesos[i] / (1 + juros / 100 * this.Pagamentos[i] / this.Periodo)
						}
					}

					if(soZero) return 0
					return (total / acumulador - 1) * 100
				}

				// Calcula os juros a parit do acréscimo
				acrescimoParaJuros(acrescimo=0, precisao=12, maximoInteracoes=100, maximoJuros=50, acrescimoComoValorOriginal=false){
					if(maximoInteracoes < 1 || this.Quantidade < 1 || precisao < 1 || this.Periodo < 1 || acrescimo < 1 ) return 0

					let minimoJuros = 0
					let medioJuros = 0
					let total = this.getPesoTotal()

					if(total == 0) return 0

					if(acrescimoComoValorOriginal){
						acrescimo = 100 * (total / acrescimo - 1)
						if(acrescimo <= 0) return 0
					}

					var minimaDiferenca = 0.1 ** precisao

					for(let i = 0; i < maximoInteracoes; i++){
						medioJuros = (minimoJuros + maximoJuros) / 2
						if((maximoJuros - minimoJuros) < minimaDiferenca) return medioJuros
						if(this.jurosParaAcrescimo(medioJuros) <= acrescimo){
							minimoJuros = medioJuros
						} else{
							maximoJuros = medioJuros
						}
					}

					return medioJuros
				}
			}

			function calcular(){
				let quantidade = Number(window.document.getElementById("quantidade").value)
				let tipo = window.document.getElementsByName("tipo")
				tipo = ! tipo[0].checked
				let periodo = Number(window.document.getElementById("periodo").value)
				let pesos = window.document.getElementById("pesos").value
				let pagamentos = window.document.getElementById("pagamentos").value
				let calculo = window.document.getElementsByName("calculo")
				calculo = calculo[0].checked
				let percentual = Number(window.document.getElementById("valor").value.replace(",", "."))
				let resultado = window.document.getElementById("resultado")

				let juros = new CalculaJuros(quantidade, tipo, periodo)
				if(! juros.setPesos(",", pesos)){
					window.alert(`Você deve informar ${quantidade} pesos numéricos ou vazio!`)
					window.document.getElementById("pesos").focus()
					return
				}
				if(! juros.setPagamentos(",", pagamentos)){
					window.alert(`Você deve informar ${quantidade} pagamentos numéricos ou vazio!`)
					window.document.getElementById("pagamentos").focus()
					return
				}

				let res_numb = ""
				if(calculo){
					res_numb = "" + juros.jurosParaAcrescimo(percentual)
				} else{
					res_numb = "" + juros.acrescimoParaJuros(percentual, 18)
				}
				res_numb = res_numb.replace(".", ",")
				resultado.innerText = "Resultado: " + res_numb + "%"
				}
		</script>
	</body>
</html>